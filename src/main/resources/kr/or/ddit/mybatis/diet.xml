<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="diet">
	<insert id="insertMenu" parameterType="Map">
		INSERT INTO MENU(MENU_NO
						,MENU_NAME
						,MENU_KCAL)
						VALUES(
						MENU_SEQ.NEXTVAL,
						#{menu_name},
						#{menu_kcal}
						)
	</insert>
	
	<insert id="insertDietMem" parameterType="dietMemVO">
		INSERT INTO DIET_MEM(DM_NO,
							HEIGHT,
	 						DATE,
	 						CURRENT_WEIGHT,
	 						PURPOSE_WEIGHT, 
	 						BMI,
							DAY_KCAL,
	 						MEM_NO)
	 						VALUES(DIET_MEM_SEQ.NEXTVAL,
	 								#{height},
	 								#{date},
	 								#{current_weight},
	 								#{purpose_weight},
	 								#{bmi},
	 								#{day_kcal},
	 								#{mem_no}
	 								)
	</insert>
	
	<select id="menuList" resultType="menuVO" parameterType="Map">
		SELECT *
		FROM MENU
		<if test="rownum != null">
		 <![CDATA[ 
		  WHERE ROWNUM < #{rownum}
    	]]>
		</if>
	</select>
	
	<select id="dietMemList" resultType="dietMemVO" parameterType="Map">
		SELECT *
		FROM DIET_MEM
		WHERE MEM_NO = #{mem_no}
	</select>
	
	<select id="menuSearch" parameterType="Map" resultType="menuVO">
		SELECT *
		FROM MENU
		<if test='menu_search != null'>
			WHERE MENU_NAME LIKE '%'||#{menu_search}||'%'
		</if>
	</select>
	
	<insert id="insertDietDay" parameterType="dietDayVO" useGeneratedKeys="true" keyColumn="DD_NO" keyProperty="dd_no">
		INSERT INTO DIET_DAY(DD_NO,
						MEM_NO,
						DD_KCAL,
						DD_DATE)
						VALUES(
						diet_day_seq.nextval,
						#{mem_no},
						0,
						#{dd_date}
						)
	</insert>
	
	<insert id="insertDietDayInfo" parameterType="dietDayInfoVO">
		INSERT INTO DIET_DAY_INFO(DDI_NO,
								DD_NO,
								MENU_NO,
								DD_INFO_DIVISION)VALUES(
									diet_day_info_seq.nextval,
									#{dd_no},
									#{menu_no},
									#{dd_info_division}
									)
								
	</insert>
	
	<update id="updateDietDayKcal" parameterType="Map">
		<selectKey keyProperty="dd_kcal" resultType="java.lang.String" order="BEFORE">
    		select sum(a.menu_kcal) dd_kcal
			from menu a,
				(select *
				from diet_day_info
				where dd_no = #{dd_no}) b
				where b.MENU_NO = a.MENU_NO
    	</selectKey>
  		UPDATE DIET_DAY SET DD_KCAL = #{dd_kcal} WHERE DD_NO = #{dd_no}  
	</update>
	
	<select id="selectDietDay" parameterType="Map" resultType="dietDayVO">
		SELECT *
		FROM DIET_DAY
		WHERE DD_DATE = #{dd_date}
		AND MEM_NO = #{mem_no}
	</select>
	
	<select id="dietDayInfoList" parameterType="Map" resultType="dietDayInfoVO">
	
		SELECT b.*, a.MENU_NAME MENU_NAME, a.menu_kcal MENU_KCAL
		FROM MENU a, (SELECT *
					FROM DIET_DAY_INFO
					where DD_NO = #{dd_no}
					<if test="dd_info_division != null">
						AND DD_INFO_DIVISION = #{dd_info_division}
					</if>) b
		WHERE b.MENU_NO = a.MENU_NO
	</select>
	
	<delete id="deleteDietDayInfo" parameterType="Map">
		DELETE DIET_DAY_INFO
		WHERE DDI_NO = #{ddi_no}
		AND DD_INFO_DIVISION = #{dd_info_division}
	</delete>
	
</mapper>


	

	
